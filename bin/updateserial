#!/usr/bin/env python
import os
import sys

# Before we do anything, make sure this is being run as root
if (os.geteuid() != 0):
  print("ERROR: This command must be run as root!")
  exit(1)

# Set the EDBG_HOME so we can make this all wrapped up in one command
os.environ["EDBG_HOME"] = "/opt/host/p9"

# Do an arg check to make sure 1 arg was given
if (len(sys.argv) != 2):
  print("ERROR: This command only takes one argument!")
  print("ERROR: Please review your command line entry and try again!")
  exit(1)

# Save what the user gave
serialnum = sys.argv[1]

# Call lhtdetcnfg.py to create a config file on this system
rc = os.system(os.environ["EDBG_HOME"] + "/bin/edbgdetcnfg")
if (rc):
  exit(rc)

# Size the serial number programming to 16 characters
serialnum = serialnum.ljust(16, ' ')

# Call the under lying VPD keyword modification
print("Updating system serial number to %s" % serialnum)
rc = os.system("%s/bin/putvpdkeyword nochip fru \"OSYS\" \"SS\" \"%s\" -i a -quiet" % (os.environ["EDBG_HOME"], serialnum))
if (rc):
  print("ERROR: A problem occurred updating the serial number(OSYS:SS).  Please see previous output for reason.")
  exit(rc)

# If we got here, neither command above enountered an error
# Print success message
print("Update complete!")
